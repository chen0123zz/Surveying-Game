<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç«™å„€ç‰¹è¨“ V81.0 (çµ²æ»‘æ°£æ³¡ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* å…¨åŸŸç¦æ­¢é¸å–æ–‡å­—èˆ‡é•·æŒ‰é¸å–® */
        * {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
            -webkit-touch-callout: none; /* ç¦æ­¢ iOS é•·æŒ‰å½ˆå‡ºé¸å–® */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šæ™‚çš„é«˜äº®è—æ¡† */
        }
        
        /* å”¯ç¨è®“ã€Œå ±å‘Šå€ã€å¯ä»¥é¸å– */
        #calc-result, #calc-result * {
            -webkit-user-select: text;
            user-select: text;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #e2e8f0; touch-action: pan-y; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* å°èˆªåˆ— Fixed */
        .nav-bar { 
            position: fixed; 
            top: 0; left: 0; right: 0;
            display: flex; 
            background: #1e293b; 
            border-bottom: 1px solid #334155; 
            z-index: 100; 
            padding-top: env(safe-area-inset-top); 
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            height: auto;
            min-height: 50px; 
        }
        .nav-btn { flex: 1; padding: 12px; text-align: center; color: #64748b; border-bottom: 3px solid transparent; transition: 0.2s; cursor: pointer; font-weight: bold; font-size: 14px; }
        .nav-btn.active { color: #22c55e; border-bottom-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

        /* ä¸»å…§å®¹å€ */
        .main-content { 
            flex: 1 1 auto; 
            overflow-y: auto; 
            margin-top: 60px; 
            padding: 20px 10px 120px 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            -webkit-overflow-scrolling: touch; 
        }

        /* SOP (é›™æ¬„) */
        .sop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; }
        .sop-slot { background: #1e293b; border: 2px dashed #475569; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; min-height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .sop-slot.filled { border-style: solid; border-color: #22c55e; background: #14532d; justify-content: flex-start; text-align: left; padding-left: 10px; }
        .sop-option { background: #334155; padding: 12px; margin: 6px 0; border-radius: 8px; cursor: pointer; border: 1px solid #475569; width: 100%; text-align: left; transition: transform 0.1s; }
        .sop-option:active { transform: scale(0.98); }
        .sop-option.selected { background: #0ea5e9; color: white; border-color: #fff; transform: translateX(5px); }

        /* Sim æ•´ç½® */
        .sim-canvas-wrap { width: 300px; height: 300px; margin: 0 auto 20px; position: relative; flex-shrink: 0; background: #000; border-radius: 50%; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        canvas { display: block; width: 100%; height: 100%; border-radius: 50%; }
        .sim-controls-box { width: 100%; max-width: 400px; background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; }

        /* --- TS æ¸¬è§’ (æ“¬çœŸå¼·åŒ–) --- */
        .status-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #4ade80; padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid #4ade80; z-index: 30; }

        .compass-ring { 
            position: absolute; inset: -10px; border-radius: 50%; 
            border: 2px dashed rgba(255,255,255,0.2); pointer-events: none; 
            display: flex; justify-content: center; align-items: center;
        }
        .compass-arrow {
            position: absolute; width: 20px; height: 20px;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 20px solid #ef4444; /* ç´…è‰²ç®­é ­ */
            transform-origin: center 150px; /* æ—‹è½‰ä¸­å¿ƒè¨­å®šç‚ºåœ“å¿ƒè·é›¢ */
            top: -20px; left: calc(50% - 10px);
            opacity: 0.8; transition: opacity 0.3s;
        }

        .telescope-view {
            width: 300px; height: 300px; margin: 0 auto 15px; border-radius: 50%;
            border: 4px solid #334155; background: #87ceeb; overflow: visible; position: relative; 
            box-shadow: inset 0 0 60px #000; flex-shrink: 0;
        }
        .telescope-mask {
            width: 100%; height: 100%; border-radius: 50%; overflow: hidden; position: relative;
        }
        .blur-layer { transition: filter 0.2s; filter: blur(0px); width: 100%; height: 100%; position: absolute; top:0; left:0; }
        
        .transit-overlay {
            position: absolute; inset: 0; background: #000; 
            display: flex; align-items: center; justify-content: center;
            color: #facc15; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }

        .crosshair { position: absolute; inset: 0; pointer-events: none; z-index: 20; display: flex; align-items: center; justify-content: center; }
        .hair-h { width: 100%; height: 2px; background: rgba(0,0,0,0.7); position: absolute; }
        .hair-v { height: 100%; width: 2px; background: rgba(0,0,0,0.7); position: absolute; }
        .center-dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 21; box-shadow: 0 0 2px #fff; }
        
        .target-wrapper { position: absolute; width: 0; height: 0; left: 50%; top: 50%; pointer-events: none; }
        .target-obj { position: absolute; width: 100px; height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; transform: translateX(-50%); }
        
        .pole { width: 10px; height: 150px; background: repeating-linear-gradient(to bottom, #ef4444 0, #ef4444 20px, #ffffff 20px, #ffffff 40px); border: 1px solid #666; }
        .prism-box { width: 70px; height: 70px; background: #f97316; border: 3px solid #1f2937; display: flex; align-items: center; justify-content: center; margin-bottom: -2px; z-index: 2; }
        .prism-glass { width: 50px; height: 50px; background: #111; border-radius: 50%; border: 3px solid #fff; position: relative; display:flex; align-items:center; justify-content:center; }
        .prism-center { width: 8px; height: 8px; background: white; border-radius: 50%; }

        /* æ§åˆ¶é¢æ¿ */
        .controls-container { width: 100%; max-width: 400px; }
        .auto-aim-btn { width: 100%; background: #eab308; color: black; font-weight: bold; padding: 12px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 3px 0 #ca8a04; transition: 0.1s; display: flex; justify-content: center; gap: 5px; }
        .auto-aim-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #ca8a04; }

        .knobs-area { display: flex; gap: 15px; background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .knob-grp { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .knob-label { font-size: 11px; color: #94a3b8; margin-bottom: 6px; font-weight: bold; }
        .btn-grp { display: flex; gap: 10px; }
        
        .arr-btn { 
            width: 50px; height: 50px; 
            background: #3b82f6; color: white; 
            border-radius: 10px; 
            font-size: 24px; font-weight: bold; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 3px 0 #1d4ed8; 
            user-select: none;
            -webkit-user-select: none;
        }
        .arr-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #1d4ed8; }

        /* èª¿ç„¦æ§åˆ¶ */
        .focus-control { width: 100%; background: #334155; padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border: 1px solid #475569; }
        .focus-icon { font-size: 14px; color: #cbd5e1; }

        /* Leica é¢æ¿ */
        .ts-face { background: #cbd5e1; padding: 15px; border-radius: 12px; border: 3px solid #475569; margin-bottom: 20px; }
        .lcd { background: #fff; border: 2px solid #64748b; height: 160px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; margin-bottom: 15px; }
        .lcd-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; padding-right: 15px; }
        .soft-keys { display: grid; grid-template-columns: repeat(4, 1fr); background: #f1f5f9; border-top: 1px solid #cbd5e1; }
        .sk { text-align: center; font-size: 12px; font-weight: bold; padding: 10px 0; border-right: 1px solid #e2e8f0; }
        .sk:last-child { border: none; }
        .sk.active { background: #22c55e; color: white; }

        .hard-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .hk { background: #1e293b; color: white; padding: 14px 0; border-radius: 6px; font-size: 14px; font-weight: bold; text-align: center; box-shadow: 0 4px 0 #0f172a; cursor: pointer; user-select: none; }
        .hk:active { transform: translateY(3px); box-shadow: none; }
        .hk.highlight { background: #22c55e; box-shadow: 0 0 15px #22c55e; border: 2px solid white; z-index: 10; animation: pulse 1s infinite; }
        .control-row { display: flex; justify-content: space-between; gap: 15px; }
        .hk.red { background: #ef4444; box-shadow: 0 4px 0 #991b1b; width: 100%; }
        .hk.func { background: #64748b; box-shadow: 0 4px 0 #334155; width: 100%; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* æ•™å­¸èˆ‡å°æŠ„ */
        .instruction-box { width: 100%; max-width: 400px; background: #1e293b; border-left: 5px solid #22c55e; padding: 15px; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .step-title { color: #22c55e; font-weight: bold; font-size: 16px; margin-bottom: 6px; display: block; }
        .step-detail { color: #fff; font-size: 14px; line-height: 1.5; margin-bottom: 8px; display: block; }
        .theory-note { background: rgba(59, 130, 246, 0.15); color: #93c5fd; padding: 8px; border-radius: 4px; font-size: 13px; border-left: 3px solid #3b82f6; margin-top: 5px; }
        .highlight-text { color: #facc15; font-weight: bold; text-decoration: underline; }

        .cheat-sheet-btn { background: #3b82f6; color: white; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .cheat-sheet-content { display: none; background: #1e293b; border: 1px solid #475569; padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; margin-bottom: 15px; }
        .cheat-step { padding: 6px; font-size: 13px; color: #94a3b8; border-bottom: 1px dashed #334155; }
        .cheat-step.active { color: #facc15; font-weight: bold; background: rgba(250, 204, 21, 0.1); border-left: 3px solid #facc15; padding-left: 8px; }

        /* å³æ™‚é‡å¸³è¡¨æ ¼ */
        .field-book { width: 100%; max-width: 400px; border-collapse: collapse; margin-top: 20px; font-size: 13px; color: #fff; background: #1e293b; border-radius: 8px; overflow: hidden; }
        .field-book th { background: #0f172a; padding: 10px; border-bottom: 2px solid #475569; text-align: left; }
        .field-book td { padding: 10px; border-bottom: 1px solid #334155; }
        .field-book tr.current { background: rgba(34, 197, 94, 0.1); }
        .val-filled { color: #facc15; font-family: monospace; font-weight: bold; }

        /* ç®—å¼å€å¡Š */
        .math-box { width: 100%; max-width: 400px; background: #1e293b; padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid #4ade80; display: none; }
        .math-title { color: #4ade80; font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed #4ade80; padding-bottom: 5px; }
        .math-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }

        /* é€šç”¨æ»‘æ¡¿èˆ‡æŒ‰éˆ• */
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; width: 100%; }
        .lbl { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 14px; border: 2px solid rgba(255,255,255,0.5); }
        input[type=range] { flex: 1; -webkit-appearance: none; background: transparent; height: 36px; }
        input[type=range]::-webkit-slider-runnable-track { height: 8px; background: #475569; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #fff; margin-top: -10px; border: 3px solid #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .btn-green { width: 100%; padding: 12px; background: #22c55e; color: white; font-weight: bold; border-radius: 8px; text-align: center; box-shadow: 0 3px 0 #15803d; cursor: pointer; margin-top: 10px; }
        .btn-green:active { transform: translateY(2px); box-shadow: none; }
        /* ç§»é™¤åŸæœ¬çš„ .slider-descï¼Œå› ç‚ºå·²ç¶“ç”¨ä¸åˆ° */

        /* å½±ç‰‡æ¸…å–®æ¨£å¼ */
        .video-card { display: flex; align-items: center; background: #1e293b; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #475569; cursor: pointer; transition: 0.2s; text-decoration: none; color: #e2e8f0; }
        .video-card:hover { background: #334155; transform: translateX(5px); border-color: #22c55e; }
        .video-icon { width: 40px; height: 40px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; color: white; font-weight: bold; font-size: 12px; }
        .video-info { flex: 1; }
        .video-title { font-weight: bold; display: block; margin-bottom: 2px; }
        .video-note { font-size: 12px; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-900">

    <div class="nav-bar">
        <div onclick="switchTab('sop')" class="nav-btn active" id="nav-sop">1. SOP</div>
        <div onclick="switchTab('sim')" class="nav-btn" id="nav-sim">2. æ•´ç½®</div>
        <div onclick="switchTab('ts')" class="nav-btn" id="nav-ts">3. æ¸¬å›æ³•</div>
        <div onclick="switchTab('video')" class="nav-btn" id="nav-video">4. å½±ç‰‡</div>
    </div>

    <div class="main-content">

        <div id="view-sop" class="p-4 w-full flex flex-col items-center">
            <h2 class="text-white text-2xl font-bold mb-6 border-l-4 border-green-500 pl-4 w-full max-w-[600px]">
                å…¨ç«™å„€æ¶è¨­ SOP
            </h2>
            <div class="sop-grid">
                <div><h3 class="text-xs text-slate-400 mb-2">æ­£ç¢ºæµç¨‹</h3><div id="sop-slots"></div></div>
                <div><h3 class="text-xs text-slate-400 mb-2">å¡ç‰‡åº«</h3><div id="sop-options"></div></div>
            </div>
            <button onclick="checkSop()" class="btn-green text-lg w-full max-w-[300px] mt-8">æª¢æŸ¥ç­”æ¡ˆ âœ…</button>
        </div>

        <div id="view-video" class="hidden w-full flex flex-col items-center p-4">
            <h2 class="text-white text-2xl font-bold mb-6 border-l-4 border-green-500 pl-4 w-full max-w-[600px]">
                åƒè€ƒå½±ç‰‡åœ–æ›¸é¤¨
            </h2>
            <div class="w-full max-w-[600px]">
                
                <a href="https://youtu.be/eORANDbNtMI?si=FtEHg4recyXE1eXT" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">æ–°åŒ—åœ°æ”¿-æ¸¬é‡åŠ©ç†è€ƒä»€éº¼?</span>
                        <span class="video-note">äº†è§£è€ƒè©¦é‡é»èˆ‡æµç¨‹</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtu.be/vJGic12snGw?si=FoPbp59RulI_Rs6q" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">ç¶“ç·¯å„€æ¶è¨­æ–¹æ³•</span>
                        <span class="video-note">å£è¨£ï¼šå¿ƒå¿ƒå¹³å¹³å¿ƒ</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtu.be/7Ib-rSUIApQ?si=4m-A-Plicn3xSqH4" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">ç¶“ç·¯å„€å®šå¿ƒå®šå¹³æ–¹æ³•</span>
                        <span class="video-note">åŸºç¤æ“ä½œè©³è§£</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtu.be/3qS5AcfDuS4?si=iXhMPZ7H5mNuUkiX" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">ç¶“ç·¯å„€å®šå¿ƒå®šå¹³æ•™å­¸</span>
                        <span class="video-note">é€²éšæŠ€å·§èªªæ˜</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtu.be/FmIGwKy_4X0?si=O9ziS7nbYupr48Gr" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">ç¶“ç·¯å„€å®šå¿ƒå®šå¹³æ“ä½œå½±ç‰‡</span>
                        <span class="video-note">å¯¦éš›æ“ä½œæµç¨‹å±•ç¤º</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtube.com/shorts/ApYIgvSv4Cw?si=J2CTwNhTc2vvvoPW" target="_blank" class="video-card">
                    <div class="video-icon">Short</div>
                    <div class="video-info">
                        <span class="video-title">Leica TS07 é–‹å•Ÿé›·å°„</span>
                        <span class="video-note">å®šå¿ƒå®šå¹³å¾Œå¦‚ä½•é–‹å•Ÿé›·å°„æ±‚å¿ƒ</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

                <a href="https://youtu.be/HZgIZgkZ_Q8?si=3UL4fSOJwCNJMr_Z" target="_blank" class="video-card">
                    <div class="video-icon">YT</div>
                    <div class="video-info">
                        <span class="video-title">å¤§ç¨œé¡æ¶è¨­æ–¹æ³•</span>
                        <span class="video-note">æ±‚å¿ƒå™¨å‹è™Ÿç¶“ç·¯å„€ä¹Ÿå¯åƒè€ƒ</span>
                    </div>
                    <span class="text-slate-400">â¤</span>
                </a>

            </div>
        </div>

        <div id="view-sim" class="hidden w-full flex flex-col items-center pt-4 p-4">
            <div id="sim-lock" class="fixed inset-0 bg-slate-900/95 z-50 flex flex-col items-center justify-center text-center p-4">
                <div class="text-5xl mb-4">ğŸ”’</div>
                <p class="text-white mb-6 font-bold">è«‹å…ˆå®Œæˆ SOP æ’åº</p>
                <button onclick="switchTab('sop')" class="px-6 py-3 bg-green-600 rounded-full text-white font-bold shadow-lg">å‰å¾€ SOP</button>
                <div class="mt-6 text-xs text-slate-500 underline cursor-pointer" onclick="forceUnlock()">[æ¸¬è©¦ç”¨] å¼·åˆ¶è§£é–</div>
            </div>
            
            <h3 id="phase-title" class="text-xl text-white font-bold mb-4">ç²—å¹³ (åœ“æ°£æ³¡)</h3>
            <div class="sim-container">
                <div class="sim-canvas-wrap"><canvas id="simCanvas" width="300" height="300"></canvas></div>
                <div class="sim-controls-box">
                    <div id="ctrl-legs" class="hidden">
                        <p class="text-center text-slate-400 text-sm mb-2">èª¿æ•´è…³æ¶é•·åº¦ï¼Œå°‡æ°£æ³¡è¶•å…¥é»‘åœˆ</p>
                        <div class="text-xs text-yellow-400 text-center mb-4 border border-yellow-500/30 bg-yellow-500/10 p-2 rounded">
                            ğŸ’¡ å£è¨£ï¼šæ°£æ³¡åœ¨å“ªé‚Šï¼Œé‚£é‚Šå°±æ¯”è¼ƒã€Œé«˜ã€<br>(è¦æŠŠé‚£éš»è…³ã€Œç¸®çŸ­ã€)
                        </div>
                        <div class="slider-row">
                            <div class="lbl" style="background:#facc15">A</div>
                            <span class="text-xs text-slate-400 w-6 text-right mr-1">ç¸®</span>
                            <input type="range" id="legA" oninput="userAction()">
                            <span class="text-xs text-slate-400 w-6 text-left ml-1">ä¼¸</span>
                        </div>
                        <div class="slider-row">
                            <div class="lbl" style="background:#4ade80">B</div>
                            <span class="text-xs text-slate-400 w-6 text-right mr-1">ç¸®</span>
                            <input type="range" id="legB" oninput="userAction()">
                            <span class="text-xs text-slate-400 w-6 text-left ml-1">ä¼¸</span>
                        </div>
                        <div class="slider-row">
                            <div class="lbl" style="background:#f87171">C</div>
                            <span class="text-xs text-slate-400 w-6 text-right mr-1">ç¸®</span>
                            <input type="range" id="legC" oninput="userAction()">
                            <span class="text-xs text-slate-400 w-6 text-left ml-1">ä¼¸</span>
                        </div>
                        <button class="btn-green" onclick="toPhase('TUBE_X')">ä¸‹ä¸€æ­¥ï¼šç²¾å¹³ â¤</button>
                    </div>
                    <div id="ctrl-tube-x" class="hidden text-center">
                        <p class="text-yellow-400 font-bold mb-4">â‘  X è»¸ï¼šèª¿æ•´è…³èºæ—‹ Aã€B</p>
                        <div class="slider-row px-2"><span class="text-xs text-white">å·¦</span><input type="range" id="screwAB" oninput="userAction()"><span class="text-xs text-white">å³</span></div>
                        <button class="btn-green" onclick="toPhase('TUBE_Y')">æ—‹è½‰ 90åº¦ â¤</button>
                    </div>
                    <div id="ctrl-tube-y" class="hidden text-center">
                        <p class="text-red-400 font-bold mb-4">â‘¡ Y è»¸ï¼šèª¿æ•´è…³èºæ—‹ C</p>
                        <div class="slider-row px-2"><span class="text-xs text-white">ä¸‹</span><input type="range" id="screwC" oninput="userAction()"><span class="text-xs text-white">ä¸Š</span></div>
                        <button class="btn-green" onclick="toPhase('GROUND')">ä¸‹ä¸€æ­¥ï¼šç²¾ç¢ºå°å¿ƒ â¤</button>
                    </div>
                    <div id="ctrl-shift" class="hidden text-center">
                        <div class="text-5xl animate-bounce mb-4">ğŸ‘†</div>
                        <p class="text-white font-bold mb-2">æ‹–æ›³ç•«é¢ç´…é»å°æº–ä¸­å¿ƒ</p>
                        <button class="btn-green" onclick="checkAll()">å®Œæˆæª¢æŸ¥ âœ…</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ts" class="hidden w-full flex flex-col items-center pt-4 p-2 pb-24">
            
            <button onclick="toggleCheatSheet()" class="cheat-sheet-btn">ğŸ“– æŸ¥çœ‹å®Œæ•´æµç¨‹</button>
            <div id="cheat-sheet" class="cheat-sheet-content">
                <div class="text-white font-bold mb-2 text-center border-b border-slate-600 pb-2">æ¸¬å›æ³•æµç¨‹</div>
                <div id="cs-1" class="cheat-step">1. æ­£é¡ - å¾Œè¦– A (æ­¸é›¶)</div>
                <div id="cs-2" class="cheat-step">2. æ­£é¡ - å‰è¦– B (æ¸¬å­˜)</div>
                <div id="cs-3" class="cheat-step">3. ç¸±è½‰ (ç¿»æˆå€’é¡)</div>
                <div id="cs-4" class="cheat-step">4. å€’é¡ - å‰è¦– B (æ¸¬å­˜)</div>
                <div id="cs-5" class="cheat-step">5. å€’é¡ - å¾Œè¦– A (æ¸¬å­˜)</div>
            </div>

            <div class="instruction-box">
                <span class="step-title" id="step-title">æ­¥é©Ÿ 1 (æ­£é¡):</span>
                <span class="step-detail" id="step-detail">è¼‰å…¥ä¸­...</span>
                <div class="theory-note" id="theory-note">ğŸ’¡ è¼‰å…¥ä¸­...</div>
            </div>

            <div class="telescope-view">
                <div id="status-badge" class="status-badge">æ­£é¡ (ç›¤å·¦)</div>
                <div class="compass-ring">
                    <div id="compass-arrow" class="compass-arrow"></div>
                </div>
                
                <div id="transit-overlay" class="transit-overlay">
                    <span class="text-2xl animate-spin">ğŸ”„</span>
                    <span class="ml-2 text-xl">å„€å™¨ç¿»è½‰ä¸­...</span>
                </div>

                <div class="telescope-mask">
                    <div id="world-layer" class="blur-layer">
                        <div id="target-wrapper" class="target-wrapper">
                            <div id="target-a" class="target-obj">
                                <div class="bg-black/70 text-white text-[10px] px-2 py-1 mb-1 rounded">å¾Œè¦– A</div>
                                <div class="prism-box"><div class="prism-glass"><div class="prism-center"></div></div></div>
                                <div class="pole"></div>
                            </div>
                            <div id="target-b" class="target-obj hidden">
                                <div class="bg-black/70 text-white text-[10px] px-2 py-1 mb-1 rounded">å‰è¦– B</div>
                                <div class="prism-box"><div class="prism-glass"><div class="prism-center"></div></div></div>
                                <div class="pole"></div>
                            </div>
                        </div>
                    </div>
                    <div class="crosshair">
                        <div class="hair-h"></div><div class="hair-v"></div><div class="center-dot"></div>
                    </div>
                </div>
            </div>

            <div class="controls-container">
                <button id="auto-aim-btn" class="auto-aim-btn" onclick="startAutoAim()">ğŸ”­ å¹«æˆ‘æ‰¾ç›®æ¨™ (å¹³æ»‘ç§»å‹•)</button>
                
                <div class="focus-control">
                    <span class="focus-icon">ğŸ” èª¿ç„¦</span>
                    <input type="range" id="focus-slider" min="0" max="100" value="0" oninput="updateFocus()">
                    <span class="focus-icon">æ¸…æ™°</span>
                </div>

                <div class="knobs-area">
                    <div class="knob-grp">
                        <div class="knob-label">â—€ æ°´å¹³ Hz â–¶</div>
                        <div class="btn-grp">
                            <button class="arr-btn" onmousedown="startSmartMove('H', -1)" onmouseup="stopSmartMove()" ontouchstart="startSmartMove('H', -1)" ontouchend="stopSmartMove()">â—€</button>
                            <button class="arr-btn" onmousedown="startSmartMove('H', 1)" onmouseup="stopSmartMove()" ontouchstart="startSmartMove('H', 1)" ontouchend="stopSmartMove()">â–¶</button>
                        </div>
                    </div>
                    <div style="width:1px; background:#475569"></div>
                    <div class="knob-grp">
                        <div class="knob-label">â–² å‚ç›´ V â–¼</div>
                        <div class="btn-grp">
                            <button class="arr-btn" onmousedown="startSmartMove('V', -1)" onmouseup="stopSmartMove()" ontouchstart="startSmartMove('V', -1)" ontouchend="stopSmartMove()">â–²</button>
                            <button class="arr-btn" onmousedown="startSmartMove('V', 1)" onmouseup="stopSmartMove()" ontouchstart="startSmartMove('V', 1)" ontouchend="stopSmartMove()">â–¼</button>
                        </div>
                    </div>
                </div>

                <div class="ts-face">
                    <div class="lcd">
                        <div class="flex justify-between text-[10px] text-gray-500 p-1 border-b"><span>Std. Meas</span><span>[|||]</span></div>
                        <div class="lcd-content">
                            <div class="text-xs text-gray-500">V: <span id="lcd-v" class="font-mono text-slate-800">90Â°00'00"</span></div>
                            <div class="text-xs text-gray-500 mt-1">Hz:</div>
                            <div class="text-3xl font-bold text-slate-900 tracking-widest font-mono" id="lcd-hz">000Â°00'00"</div>
                        </div>
                        <div class="soft-keys">
                            <div class="sk" id="lbl-f1">æ¸¬å­˜</div><div class="sk" id="lbl-f2">æ¸¬è·</div>
                            <div class="sk" id="lbl-f3">è¨˜éŒ„</div><div class="sk" id="lbl-f4" style="border:none">â†“</div>
                        </div>
                    </div>
                    <div class="hard-keys">
                        <button class="hk" id="btn-f1" onclick="pressFkey(1)">F1</button>
                        <button class="hk" id="btn-f2" onclick="pressFkey(2)">F2</button>
                        <button class="hk" id="btn-f3" onclick="pressFkey(3)">F3</button>
                        <button class="hk" id="btn-f4" onclick="pressFkey(4)">F4</button>
                    </div>
                    <div class="control-row">
                        <button class="hk func" id="btn-func" onclick="doTransit()">Fnc (å€’é¡)</button>
                        <button class="hk red" onclick="startSurvey()">Esc (é‡ç½®)</button>
                    </div>
                </div>
            </div>

            <table class="field-book">
                <thead><tr><th>æ­¥é©Ÿ</th><th>ç›®æ¨™</th><th>æ°´å¹³è§’è®€æ•¸</th></tr></thead>
                <tbody>
                    <tr id="row-1"><td>1.æ­£é¡</td><td>å¾Œè¦– A</td><td id="val-1">--</td></tr>
                    <tr id="row-2"><td>2.æ­£é¡</td><td>å‰è¦– B</td><td id="val-2">--</td></tr>
                    <tr id="row-4"><td>3.å€’é¡</td><td>å‰è¦– B</td><td id="val-4">--</td></tr>
                    <tr id="row-5"><td>4.å€’é¡</td><td>å¾Œè¦– A</td><td id="val-5">--</td></tr>
                </tbody>
            </table>
            <div id="calc-result" class="math-box"></div>
        </div>
    </div>

    <script>
        let isSopPassed = false;
        let softKeyPage = 1;
        let isTransiting = false;
        
        let targetLegA = 50, targetLegB = 50, targetLegC = 50;

        function switchTab(tab){
            document.querySelectorAll('[id^="view-"]').forEach(el=>el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById('view-'+tab).classList.remove('hidden');
            document.getElementById('nav-'+tab).classList.add('active');
            if(tab==='sim'){
                if(isSopPassed) { document.getElementById('sim-lock').style.display = 'none'; }
                const cvs=document.getElementById('simCanvas'); cvs.width=300; cvs.height=300; initPhysics();
            }
            if(tab==='ts'){ startSurvey(); }
        }
        function toggleCheatSheet() { const el = document.getElementById('cheat-sheet'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }

        // --- SOP ---
        const sopData = [
            { t: "æ¶è¨­å„€å™¨", d: "æ‹‰é«˜è…³æ¶è‡³èƒ¸å£ï¼Œå¼µé–‹æ¶è¨­ï¼Œé–ç·Šå„€å™¨èˆ‡è…³æ¶" },
            { t: "ç²—ç•¥å®šå¿ƒ", d: "æ¬å‹•æ•´çµ„è…³æ¶ï¼Œè®“é›·å°„/å…‰å­¸æ±‚å¿ƒå™¨å¤§è‡´å°æº–åœ°é¢é»" },
            { t: "è¸©å¯¦è…³æ¶", d: "ç”¨åŠ›å°‡ä¸‰éš»è…³è¸©å…¥åœŸä¸­ (é—œéµæ­¥é©Ÿï¼Œå¦å‰‡æœƒè·‘æ‰)" },
            { t: "ç²—å®šå¹³ (åœ“)", d: "ä¼¸ç¸®ä¸‰æ”¯è…³æ¶çš„é•·åº¦ï¼Œè®“åœ“æ°£æ³¡å±…ä¸­" },
            { t: "ç²¾å®šå¹³ (é•·)", d: "èª¿æ•´è…³èºæ—‹ï¼Œè®“é•·æ°£æ³¡åœ¨ X/Y è»¸éƒ½å±…ä¸­" },
            { t: "ç²¾ç¢ºå®šå¿ƒ", d: "é¬†é–‹ä¸­å¿ƒèºçµ²ï¼Œå¹³ç§»æ©Ÿèº«å°æº–ï¼Œå†é–ç·Š" },
            { t: "åè¦†æª¢æŸ¥", d: "å¹³ç§»å¾Œæ°´å¹³å¯èƒ½è·‘æ‰ï¼Œéœ€å›åˆ°ç²¾å®šå¹³å†æ¬¡æª¢æŸ¥" }
        ];
        let sopSlots=Array(7).fill(null); let sopPool=[...sopData].sort(()=>Math.random()-0.5); let selIdx=-1;
        function initSop(){
            const sEl=document.getElementById('sop-slots'); sEl.innerHTML=''; const oEl=document.getElementById('sop-options'); oEl.innerHTML='';
            
            sopSlots.forEach((item,i)=>{
                let d=document.createElement('div'); d.className=`sop-slot ${item?'filled':''}`;
                if(item) {
                    d.innerHTML=`<div class="text-left w-full"><div class="text-yellow-400 font-bold mb-1">ã€${item.t}ã€‘</div><div class="text-white text-sm">${item.d}</div></div>`;
                } else {
                    d.innerHTML=`<span class="text-slate-500 text-sm font-bold w-full text-center">æµç¨‹ ${i+1}</span>`;
                }
                d.onclick=()=>{if(selIdx!==-1){if(sopSlots[i])sopPool.push(sopSlots[i]); sopSlots[i]=sopPool[selIdx]; sopPool[selIdx]=null; selIdx=-1; initSop();}else if(sopSlots[i]){sopPool.push(sopSlots[i]); sopSlots[i]=null; initSop();}}; sEl.appendChild(d);
            });

            sopPool.forEach((item,i)=>{
                if(!item)return; let d=document.createElement('div'); d.className=`sop-option ${selIdx===i?'selected':''}`; 
                d.innerHTML=`<div class="text-yellow-400 font-bold mb-1">ã€${item.t}ã€‘</div><div class="text-gray-300 text-sm">${item.d}</div>`;
                d.onclick=()=>{selIdx=(selIdx===i)?-1:i; initSop();}; oEl.appendChild(d);
            });
        }
        function checkSop(){ if(sopSlots.every((v,i)=>v&&v.t===sopData[i].t)){ isSopPassed=true; alert("ğŸ‰ æ­£ç¢ºï¼è§£é–å„€å™¨ï¼"); document.getElementById('sim-lock').style.display='none'; switchTab('sim'); } else { alert("âŒ é †åºæœ‰èª¤ï¼"); } }
        function forceUnlock(){ isSopPassed=true; document.getElementById('sim-lock').style.display='none'; switchTab('sim'); }
        initSop();

        // --- Sim Engine ---
        const canvas=document.getElementById('simCanvas'); const ctx=canvas.getContext('2d'); const CX=150, CY=150;
        let phase='ROUGH', tiltX=0, tiltY=0, posX=0, posY=0, renderX=0, renderY=0, velX=0, velY=0, simRunning=false;
        
        function initPhysics(){ 
            targetLegA = 20 + Math.random() * 60;
            targetLegB = 20 + Math.random() * 60;
            targetLegC = 20 + Math.random() * 60;

            document.getElementById('legA').value = Math.floor(Math.random() * 100);
            document.getElementById('legB').value = Math.floor(Math.random() * 100);
            document.getElementById('legC').value = Math.floor(Math.random() * 100);

            userAction();
            
            renderX = tiltX; 
            renderY = tiltY; 
            posX=(Math.random()-0.5)*5; 
            posY=(Math.random()-0.5)*5; 
            
            phase='ROUGH'; 
            updateUI(); 
            if(!simRunning){simRunning=true; requestAnimationFrame(simLoop);} 
        }

        function resetSim(){phase='ROUGH'; initPhysics();}
        
        function userAction(){
            let lA=parseInt(document.getElementById('legA').value);
            let lB=parseInt(document.getElementById('legB').value);
            let lC=parseInt(document.getElementById('legC').value);
            
            let sAB=parseInt(document.getElementById('screwAB').value);
            let sC=parseInt(document.getElementById('screwC').value);
            
            let diffA = lA - targetLegA;
            let diffB = lB - targetLegB;
            let diffC = lC - targetLegC;

            // V80.0 ä¿®æ­£ï¼šYè»¸æ°£æ³¡é‚è¼¯ (sC - 50 æ”¹ç‚º -(sC - 50))
            tiltX = (diffB - diffA) * 3.0 + (sAB - 50) * 0.5; 
            tiltY = ((diffA + diffB) / 2 - diffC) * 3.0 - (sC - 50) * 0.5;
        }

        function toPhase(p){phase=p; updateUI();}
        function checkAll(){ let bErr=Math.sqrt(renderX**2+renderY**2); let cErr=Math.sqrt(posX**2+posY**2); if(bErr<3 && cErr<3){alert("ğŸ‰ å®Œç¾ï¼å‰å¾€æ¸¬è§’"); switchTab('ts');} else if(cErr<3 && bErr>=3){alert("âš ï¸ ç´…é»æº–äº†ï¼Œä½†æ°£æ³¡æ­ªäº†ï¼"); toPhase('TUBE_X');} else{alert("âŒ é‚„æ²’èª¿å¥½å–”ï¼");} }
        function updateUI(){
            ['ctrl-legs','ctrl-tube-x','ctrl-tube-y','ctrl-shift'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('phase-title').innerText=phase==='ROUGH'?"ç²—å¹³ (åœ“æ°£æ³¡)":phase.includes('TUBE')?"ç²¾å¹³ (é•·æ°£æ³¡)":"ç²¾ç¢ºå°å¿ƒ";
            if(phase==='ROUGH')document.getElementById('ctrl-legs').classList.remove('hidden');
            else if(phase==='TUBE_X')document.getElementById('ctrl-tube-x').classList.remove('hidden');
            else if(phase==='TUBE_Y')document.getElementById('ctrl-tube-y').classList.remove('hidden');
            else document.getElementById('ctrl-shift').classList.remove('hidden');
        }
        
        // V78.0 ä¿®æ­£ï¼šæ‰‹å‹•è¨ˆç®— Touch ç§»å‹•é‡ (è§£æ±ºç´…é»æ¶ˆå¤±å•é¡Œ)
        let isDrag=false; 
        let lastTouchX = 0;
        let lastTouchY = 0;

        canvas.addEventListener('mousedown',()=>isDrag=true); 
        window.addEventListener('mouseup',()=>isDrag=false);
        canvas.addEventListener('mousemove',e=>{
            if(isDrag && phase==='GROUND'){
                posX-=e.movementX*0.5; 
                posY-=e.movementY*0.5; 
                tiltX+=(Math.random()-0.5)*8; 
                tiltY+=(Math.random()-0.5)*8;
            }
        });
        
        canvas.addEventListener('touchstart',e=>{
            isDrag=true; 
            e.preventDefault(); // é˜²æ­¢ç•«é¢è·Ÿè‘—æ²å‹•
            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
        }); 
        
        window.addEventListener('touchend',()=>isDrag=false);
        
        canvas.addEventListener('touchmove',e=>{
            if(isDrag && phase==='GROUND'){
                e.preventDefault(); 
                let t=e.touches[0]; 
                
                // æ‰‹å‹•è¨ˆç®— delta
                let deltaX = t.clientX - lastTouchX;
                let deltaY = t.clientY - lastTouchY;
                
                // æ›´æ–°ä½ç½®
                posX -= deltaX * 0.5; 
                posY -= deltaY * 0.5; 
                
                // æ›´æ–° lastTouch
                lastTouchX = t.clientX;
                lastTouchY = t.clientY;

                tiltX+=(Math.random()-0.5)*8; 
                tiltY+=(Math.random()-0.5)*8;
            }
        });

        function simLoop(){
            if(document.getElementById('view-sim').classList.contains('hidden')){simRunning=false; return;}
            
            // V81.0 ç‰©ç†å¼•æ“å„ªåŒ–ï¼šå¢åŠ é»æ»¯æ„Ÿ (Viscosity)
            // å½ˆåŠ› (Tension) é™ä½ï¼šè®“æ°£æ³¡è¿½è¹¤ç›®æ¨™è®Šæ…¢ï¼Œç”¢ç”Ÿã€Œæ‹–æ›³æ„Ÿã€
            let ax = (tiltX - renderX) * 0.03; 
            // æ‘©æ“¦ (Friction) å¢åŠ ï¼šè®“æ°£æ³¡æ»‘è¡Œè·é›¢è®Šé•·ï¼Œç”¢ç”Ÿã€Œå¤æºœæ„Ÿã€
            let ay = (tiltY - renderY) * 0.03; 
            
            velX += ax; 
            velY += ay; 
            
            velX *= 0.92; // é˜»å°¼ä¿‚æ•¸ (è¶Šé«˜è¶Šæ»‘)
            velY *= 0.92; 
            
            renderX += velX; 
            renderY += velY;
            
            posX+=(Math.random()-0.5)*0.1; posY+=(Math.random()-0.5)*0.1;
            ctx.fillStyle="#1e293b"; ctx.fillRect(0,0,300,300); ctx.beginPath(); ctx.arc(CX,CY,145,0,Math.PI*2); ctx.fillStyle=phase==='GROUND'?"#fff":"#0f172a"; ctx.fill(); ctx.strokeStyle="#475569"; ctx.lineWidth=6; ctx.stroke();
            if(phase==='ROUGH'){
                ctx.beginPath(); ctx.moveTo(CX,CY-90); ctx.lineTo(CX-80,CY+50); ctx.lineTo(CX+80,CY+50); ctx.closePath(); ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=2; ctx.stroke();
                ctx.font="bold 16px Arial"; ctx.fillStyle="#f87171"; ctx.fillText("C", CX, CY-105); ctx.fillStyle="#facc15"; ctx.fillText("A", CX-95, CY+60); ctx.fillStyle="#4ade80"; ctx.fillText("B", CX+95, CY+60);
                ctx.beginPath(); ctx.arc(CX,CY,70,0,Math.PI*2); ctx.fillStyle="rgba(255,255,255,0.1)"; ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.arc(CX,CY,12,0,Math.PI*2); ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.stroke();
                let bx=renderX*1.5, by=renderY*1.5; let d=Math.sqrt(bx*bx+by*by); if(d>60){bx*=60/d; by*=60/d; } ctx.beginPath(); ctx.arc(CX+bx,CY+by,16,0,Math.PI*2); ctx.fillStyle="#4ade80"; ctx.fill();
            }else if(phase.includes('TUBE')){
                ctx.save(); ctx.translate(CX,CY); if(phase==='TUBE_Y') ctx.rotate(Math.PI/2);
                ctx.fillStyle="#cbd5e1"; ctx.roundRect(-110,-25,220,50,5); ctx.fill(); ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-15,-25); ctx.lineTo(-15,25); ctx.moveTo(15,-25); ctx.lineTo(15,25); ctx.stroke();
                let val=phase==='TUBE_X'?renderX:renderY; let bx=val*15; if(bx>90)bx=90; if(bx<-90)bx=-90; ctx.fillStyle="rgba(74,222,128,0.9)"; ctx.roundRect(bx-20,-18,40,36,8); ctx.fill(); ctx.restore();
            }else{
                ctx.strokeStyle="#000"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(CX,0); ctx.lineTo(CX,300); ctx.moveTo(0,CY); ctx.lineTo(300,CY); ctx.stroke(); ctx.fillStyle="#ef4444"; ctx.beginPath(); ctx.arc(CX+posX,CY+posY,5,0,Math.PI*2); ctx.fill();
            }
            requestAnimationFrame(simLoop);
        }

        // --- TS Logic ---
        let angBS=0, angFS=0, camHz=0, camV=90, targetA={h:0,v:90}, targetB={h:0,v:85}, isFaceLeft=true, moveInt, currentStep=0;
        let recData = {L_BS:null, L_FS:null, R_FS:null, R_BS:null};

        function startSurvey() {
            targetA={h:0,v:90}; targetB={h:60+Math.random()*100, v:88+Math.random()*4}; camHz=Math.random()*360; camV=80+Math.random()*20;
            isFaceLeft=true; recData={L_BS:null,L_FS:null,R_FS:null,R_BS:null}; currentStep=1;
            document.getElementById('focus-slider').value = 0; updateFocus();
            for(let i of [1,2,4,5]) {
                 let cell = document.getElementById(`val-${i}`);
                 if(cell) { cell.innerHTML = "--"; cell.classList.remove('val-filled'); }
            }
            document.querySelectorAll('.field-book tr').forEach(tr => tr.classList.remove('current'));
            document.getElementById('calc-result').style.display='none';
            updateSoftKeys(); updateSurveyView();
        }
        
        function startAutoAim() {
            if(isTransiting) return;
            let t = null;
            if(currentStep===1 || currentStep===5) t=targetA;
            else if(currentStep===2 || currentStep===4) t=targetB;
            
            if(t) {
                let offset = isFaceLeft ? 0 : 180;
                let targetHz = (t.h + offset) % 360; 
                let targetV = isFaceLeft ? t.v : 360 - t.v;
                
                // --- V61.0: Add Random Error (Simulation of human inaccuracy) ---
                let errorHz = (Math.random() - 0.5) * 0.005; 
                let errorV = (Math.random() - 0.5) * 0.005;

                let finalHz = targetHz + errorHz;
                let finalV = targetV + errorV;
                
                let startHz = camHz; let startV = camV;
                let steps = 20; let i = 0;
                let interval = setInterval(() => {
                    i++;
                    camHz = startHz + (finalHz - startHz) * (i/steps);
                    camV = startV + (finalV - startV) * (i/steps);
                    updateSurveyView();
                    if(i >= steps) { 
                        clearInterval(interval); 
                        camHz=finalHz; camV=finalV; 
                        updateSurveyView(); 
                    }
                }, 20);
            } else if (currentStep===3) { alert("ç¾åœ¨ä¸éœ€è¦æ‰¾ç›®æ¨™ï¼\nè«‹æŒ‰ [Fnc] æŒ‰éˆ•é€²è¡Œç¸±è½‰ã€‚"); }
        }

        function updateFocus() {
            let v = parseInt(document.getElementById('focus-slider').value);
            let blur = Math.abs(50 - v) / 10; // 50 is perfect
            document.getElementById('world-layer').style.filter = `blur(${blur}px)`;
        }

        function doTransit(){ 
            if(currentStep===3) { 
                isTransiting = true;
                document.getElementById('transit-overlay').style.opacity = 1;
                setTimeout(() => {
                    isFaceLeft = !isFaceLeft; 
                    camHz = (camHz+180)%360; camV = 360-camV; 
                    currentStep=4; 
                    document.getElementById('transit-overlay').style.opacity = 0;
                    document.getElementById('status-badge').innerText = "å€’é¡ (ç›¤å³)";
                    document.getElementById('status-badge').style.borderColor = "#facc15";
                    document.getElementById('status-badge').style.color = "#facc15";
                    isTransiting = false;
                    updateSurveyView();
                }, 1000);
            } else { alert("åªæœ‰åœ¨ã€Œæ­¥é©Ÿ 3ã€æ‰éœ€è¦ç¸±è½‰å–”ï¼"); }
        }

        // V70.0 ä¿®æ”¹ï¼šé™ä½å–®æ¬¡é»æ“Šçš„ç§»å‹•é‡ï¼Œæ¨¡æ“¬ã€Œå¾®å‹•èºæ—‹ã€
        function startSmartMove(axis, dir) {
            if(isTransiting) return;
            
            // ğŸ”¥ é€™è£¡æ”¹äº†ï¼šæŠŠ 0.01 æ”¹æˆ 0.002 (ç´„ 7ç§’)
            // é€™æ¨£å¦³å°±å¯ä»¥é€²è¡Œã€Œå¾®ç±³ç´šã€çš„æ“ä½œï¼Œä¸å†æ‰‹æ»‘çˆ†æ‰ï¼
            if(axis==='H'){
                camHz += dir * 0.002;
            } else {
                camV += dir * 0.002;
            } 
            updateSurveyView(); 
            
            if(moveInt) clearInterval(moveInt);
            
            // ä¸‹é¢æ˜¯é•·æŒ‰åŠ é€Ÿçš„é‚è¼¯ (ç¶­æŒä¸è®Šï¼Œè®“å¦³é‚„èƒ½å¿«é€Ÿè½‰å‹•)
            let speed = 0.05;
            moveInt = setTimeout(() => {
                moveInt = setInterval(() => {
                    speed *= 1.1; if(speed>2)speed=2;
                    if(axis==='H'){camHz+=dir*speed; if(camHz>=360)camHz-=360; if(camHz<0)camHz+=360;} else{camV+=dir*speed;}
                    updateSurveyView();
                }, 30);
            }, 300);
        }
        function stopSmartMove() { clearTimeout(moveInt); clearInterval(moveInt); moveInt=null; }

        function updateSoftKeys() {
            const f1=document.getElementById('lbl-f1'); const f2=document.getElementById('lbl-f2'); 
            const f3=document.getElementById('lbl-f3'); const f4=document.getElementById('lbl-f4');
            if(softKeyPage === 1) { f1.innerText="æ¸¬å­˜"; f2.innerText="æ¸¬è·"; f3.innerText="è¨˜éŒ„"; f4.innerText="â†“"; } 
            else { f1.innerText="è¨­è§’"; f2.innerText="0SET"; f3.innerText="ä¿ç•™"; f4.innerText="â†“"; }
        }

        // V64.0 - Removed "Aligned" Text Prompts + V65.0 Removed "Blurry" Warning
        function updateSurveyView() {
            const scale=30; 
            let distA_Normal = getDiff(camHz, targetA.h); let distA_Invert = getDiff(camHz, (targetA.h + 180) % 360);
            let daH = Math.abs(distA_Normal) < Math.abs(distA_Invert) ? distA_Normal : distA_Invert;
            let daV = Math.abs(distA_Normal) < Math.abs(distA_Invert) ? targetA.v - camV : (360 - targetA.v) - camV;

            let distB_Normal = getDiff(camHz, targetB.h); let distB_Invert = getDiff(camHz, (targetB.h + 180) % 360);
            let dbH = Math.abs(distB_Normal) < Math.abs(distB_Invert) ? distB_Normal : distB_Invert;
            let dbV = Math.abs(distB_Normal) < Math.abs(distB_Invert) ? targetB.v - camV : (360 - targetB.v) - camV;

            let tA = document.getElementById('target-a'); let tB = document.getElementById('target-b');
            
            // V73.0 ä¿®æ­£ï¼šå‚ç›´åç§»é‡æ”¹ç‚º -60px (å¾€ä¸Šæ‹‰)ï¼Œè§£æ±ºã€Œç„æº–å³æ¶ˆå¤±ã€çš„BUG
            tA.style.transform = `translate(${Math.round(daH*scale)}px, ${Math.round(-61.5 + daV*scale)}px) translateX(-50%)`;
            tB.style.transform = `translate(${Math.round(dbH*scale)}px, ${Math.round(-61.5 + dbV*scale)}px) translateX(-50%)`;
            
            let distA = Math.sqrt(daH*daH + daV*daV); tA.style.opacity = Math.max(0, 1 - distA/5); tA.classList.toggle('hidden', distA > 5);
            let distB = Math.sqrt(dbH*dbH + dbV*dbV); tB.style.opacity = Math.max(0, 1 - distB/5); tB.classList.toggle('hidden', distB > 5);
            
            // --- V60 å…¨æ–¹ä½é›·é”é‚è¼¯ ---
            let isTargetA = (distA < distB);
            let dH = isTargetA ? daH : dbH;
            let dV = isTargetA ? daV : dbV;
            let totalDist = Math.sqrt(dH*dH + dV*dV);

            let arrowAngle = (Math.atan2(dV, dH) * 180 / Math.PI) + 90;

            let arrowEl = document.getElementById('compass-arrow');
            arrowEl.style.transform = `rotate(${arrowAngle}deg)`;
            arrowEl.style.opacity = (totalDist < 20 && totalDist > 2) ? 1 : 0;

            // V64.0: ç´”ç²¹å…§éƒ¨åˆ¤æ–·ç”¨ï¼Œä¸é¡¯ç¤ºçµ¦ä½¿ç”¨è€…
            let aimA = distA < 0.05; 
            let aimB = distB < 0.05;

            document.getElementById('lcd-hz').innerText = toDMS(camHz); document.getElementById('lcd-v').innerText = toDMS(camV);

            const detail = document.getElementById('step-detail');
            const theory = document.getElementById('theory-note');
            
            document.querySelectorAll('.hk, .sk').forEach(el=>el.classList.remove('highlight', 'active'));
            document.querySelectorAll('.cheat-step').forEach(el=>el.classList.remove('active'));
            if(currentStep<=5) document.getElementById(`cs-${currentStep}`).classList.add('active');

            const aimBtn = document.getElementById('auto-aim-btn');
            if(currentStep===1 || currentStep===5) aimBtn.innerText = "ğŸ”­ å¸¶æˆ‘å»æ‰¾ [å¾Œè¦– A]";
            else if(currentStep===2 || currentStep===4) aimBtn.innerText = "ğŸ”­ å¸¶æˆ‘å»æ‰¾ [å‰è¦– B]";
            else if(currentStep===3) aimBtn.innerText = "â›” æš«åœå°èˆª (è«‹ç¿»é¢)";
            else aimBtn.innerText = "ğŸ‰ ä»»å‹™å®Œæˆ";

            let focused = Math.abs(50 - parseInt(document.getElementById('focus-slider').value)) < 10;
            
            // V65.0: ç§»é™¤æ¨¡ç³Šè­¦å‘Šæç¤º

            // V64.0 ä¿®æ”¹ï¼šåªé¡¯ç¤ºæ“ä½œæŒ‡ä»¤ï¼Œå®Œå…¨ä¸æç¤ºæ˜¯å¦ã€Œå·²ç…§æº–ã€
            if(currentStep===1) {
                document.getElementById('step-title').innerText = "æ­¥é©Ÿ 1 (æ­£é¡):";
                theory.innerText = "ğŸ’¡ åŸç†ï¼šå¾Œè¦–é»(A)æ˜¯åŸºæº–ï¼Œå¿…é ˆè¨­ç‚º 0 åº¦ï¼Œæ¸¬é‡æ‰æœ‰æ„ç¾©ã€‚";
                if(softKeyPage === 1) { 
                    detail.innerHTML = "è«‹ç…§æº– [å¾Œè¦– A]ï¼Œä¸¦æŒ‰ F4 (â†“) ç¿»é ã€‚"; 
                    document.getElementById('lbl-f4').classList.add('active'); 
                } else { 
                    detail.innerHTML = "è«‹æŒ‰ F1 (è¨­è§’) æ­¸é›¶ã€‚"; 
                    document.getElementById('lbl-f1').classList.add('active'); 
                }
            } else if(currentStep===2) {
                document.getElementById('step-title').innerText = "æ­¥é©Ÿ 2 (æ­£é¡):";
                theory.innerText = "ğŸ’¡ åŸç†ï¼šè½‰å‘ç›®æ¨™(B)æ¸¬é‡ï¼Œæ­¤æ™‚è®€æ•¸å³ç‚ºæ­£é¡æ–¹å‘è§’ã€‚";
                if(softKeyPage === 2) { 
                    detail.innerHTML = "æ­¸é›¶å®Œæˆï¼è«‹æŒ‰ F4 (â†“) è¿”å›ç¬¬ä¸€é ã€‚"; 
                    document.getElementById('lbl-f4').classList.add('active'); 
                    return; 
                }
                detail.innerHTML = "è«‹ç…§æº– [å‰è¦– B]ï¼Œä¸¦æŒ‰ F1 (æ¸¬å­˜)ã€‚"; 
                document.getElementById('lbl-f1').classList.add('active');
            } else if(currentStep===3) {
                document.getElementById('step-title').innerText = "æ­¥é©Ÿ 3 (ç¿»é¢):";
                theory.innerText = "ğŸ’¡ åŸç†ï¼šç¸±è½‰å„€å™¨åˆ‡æ›è‡³å€’é¡ï¼Œæº–å‚™æ¶ˆé™¤è¦–æº–è»¸èª¤å·®ã€‚"; 
                detail.innerHTML = "è«‹æŒ‰ [Fnc] ç¸±è½‰å„€å™¨"; 
                document.getElementById('btn-func').classList.add('highlight');
            } else if(currentStep===4) {
                document.getElementById('step-title').innerText = "æ­¥é©Ÿ 4 (å€’é¡):";
                theory.innerText = "ğŸ’¡ åŸç†ï¼šå€’é¡æ¸¬é‡ç›®æ¨™(B)ï¼Œç†è«–è®€æ•¸æ‡‰å·® 180 åº¦ã€‚";
                detail.innerHTML = "è«‹ç…§æº– [å‰è¦– B]ï¼Œä¸¦æŒ‰ F1 (æ¸¬å­˜)ã€‚";
                document.getElementById('lbl-f1').classList.add('active');
            } else if(currentStep===5) {
                document.getElementById('step-title').innerText = "æ­¥é©Ÿ 5 (å€’é¡):";
                theory.innerText = "ğŸ’¡ åŸç†ï¼šæœ€å¾Œå›åˆ°(A)é»é–‰åˆï¼Œæª¢æŸ¥å„€å™¨æ˜¯å¦è·‘æ‰ã€‚";
                detail.innerHTML = "è«‹è½‰å› [å¾Œè¦– A]ï¼Œä¸¦æŒ‰ F1 (æ¸¬å­˜) çµæŸã€‚";
                document.getElementById('lbl-f1').classList.add('active');
            } else {
                document.getElementById('step-title').innerText = "ğŸ‰ æ­å–œå®Œæˆï¼"; 
                detail.innerText = "æ¸¬å›çµæŸï¼Œè«‹å¾€ä¸‹æ»‘æŸ¥çœ‹å ±è¡¨ã€‚"; 
                theory.style.display='none';
            }
        }

        function pressFkey(k){
            if(isTransiting) return;
            if(k===4) { softKeyPage = softKeyPage===1?2:1; updateSoftKeys(); updateSurveyView(); return; }
            if(currentStep===1 && softKeyPage===2 && (k===1)) { if(confirm("ç¢ºå®šæ­¸é›¶ (SetHz=0)?")) { let off=camHz; targetA.h-=off; targetB.h-=off; camHz=0; recData.L_BS=0; updateTable(1, 0); currentStep=2; softKeyPage=1; updateSoftKeys(); updateSurveyView(); } return; }
            if(currentStep>1 && softKeyPage===2 && k<=3) { alert("âš ï¸ è«‹æŒ‰ F4 (â†“) åˆ‡æ›å›ç¬¬ä¸€é ï¼"); return; }
            if(k===1 && softKeyPage===1) { let val=camHz; if(currentStep===2) { if(val===0){alert("âš ï¸ è§’åº¦ç‚º 0ï¼è«‹å…ˆç…§æº– B é»ï¼");return;} recData.L_FS=val; updateTable(2, val); currentStep=3; updateSurveyView(); } else if(currentStep===4) { recData.R_FS=val; updateTable(4, val); currentStep=5; updateSurveyView(); } else if(currentStep===5) { recData.R_BS=val; updateTable(5, val); currentStep=6; showReport(); updateSurveyView(); } }
        }

        function updateTable(step, val) { 
            document.querySelectorAll('.field-book tr').forEach(tr => tr.classList.remove('current'));
            let c=document.getElementById(`val-${step}`); 
            if(c){ 
                c.innerText=toDMS(val); 
                c.className="val-filled"; 
                let r = document.getElementById(`row-${step}`);
                if(r) r.classList.add("current");
            } 
        }

        function getDiff(a,b){let d=b-a; while(d>180)d-=360; while(d<-180)d+=360; return d;}
        function toDMS(v){if(v<0)v+=360; let d=Math.floor(v), m=Math.floor((v-d)*60), s=Math.floor(((v-d)*60-m)*60); return `${d}Â°${String(m).padStart(2,'0')}'${String(s).padStart(2,'0')}"`;}
        
        // V67.1 ä¿®æ­£ç‰ˆï¼šä¿®å¾©åº¦æ•¸ç¬¦è™Ÿé¡¯ç¤ºäº‚ç¢¼çš„å•é¡Œ
        function showReport() {
            let div = document.getElementById('calc-result'); div.style.display = 'block';
            
            // å–å¾—å„é …æ•¸å€¼ (ä½¿ç”¨ 0 ä½œç‚ºé è¨­å€¼ï¼Œé¿å… null å ±éŒ¯)
            let val_L_BS = recData.L_BS !== null ? recData.L_BS : 0;
            let val_L_FS = recData.L_FS !== null ? recData.L_FS : 0;
            let val_R_FS = recData.R_FS !== null ? recData.R_FS : 0;
            let val_R_BS = recData.R_BS !== null ? recData.R_BS : 0;

            // è¨ˆç®—è§’åº¦ (è™•ç†è² å€¼åŠ 360)
            let angL = val_L_FS - val_L_BS;
            if(angL < 0) angL += 360;

            let angR = val_R_FS - val_R_BS;
            if(angR < 0) angR += 360;

            let final = (angL + angR) / 2;

            // --- V69.0: è¨ˆç®—æ¸¬å›å·® (Double Centering Difference) ---
            // ä¹Ÿå°±æ˜¯æ­£é¡è§’èˆ‡å€’é¡è§’çš„å·®å€¼
            let diff = Math.abs(angL - angR);
            // è™•ç†è·¨è¶Š 360 åº¦çš„é‚Šç•Œç‹€æ³ (ä¾‹å¦‚ 0åº¦ vs 359åº¦)
            if(diff > 180) diff = 360 - diff;
            
            // è½‰æ›æˆç§’æ•¸æ–¹ä¾¿æ¯”è¼ƒ
            let diffSec = Math.round(diff * 3600);
            
            // è¨­å®šåˆæ ¼æ¨™æº–ï¼š40ç§’
            let isPass = diffSec <= 40;
            let statusBadge = isPass 
                ? `<span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold">ğŸ† åˆæ ¼</span>` 
                : `<span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">âŒ ä¸åˆæ ¼ (éœ€é‡æ¸¬)</span>`;

            div.innerHTML = `
                <div class="bg-slate-800 p-5 rounded-xl border border-green-500 shadow-lg text-slate-300 space-y-2">
                    <div class="flex justify-between items-center border-b border-slate-600 pb-2 mb-2">
                        <h3 class="text-xl font-bold text-green-400">æ¸¬é‡å ±å‘Šæ›¸</h3>
                        ${statusBadge}
                    </div>
                    
                    <div class="flex justify-between"><span>æ­£é¡è§’ (L):</span> <span class="font-mono text-yellow-400">${toDMS(angL)}</span></div>
                    <div class="flex justify-between"><span>å€’é¡è§’ (R):</span> <span class="font-mono text-yellow-400">${toDMS(angR)}</span></div>
                    <div class="flex justify-between text-sm text-gray-400"><span>æ¸¬å›å·® ( |L-R| ):</span> <span class="font-mono">${diffSec}" (æ¨™æº–:40")</span></div>
                    
                    <hr class="border-slate-600">
                    <div class="flex justify-between font-bold text-lg text-white"><span>æœ€æˆ–æ˜¯å€¼ (å¹³å‡):</span> <span>${toDMS(final)}</span></div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-600">
                        <h4 class="text-green-400 font-bold mb-2">ğŸ“ è¨ˆç®—éç¨‹è©³ç´° (ç›´å¼)</h4>
                        
                        <div class="text-xs text-yellow-300 mb-4 p-2 border border-yellow-500/30 rounded bg-yellow-500/10">
                            ğŸ’¡ å°æç¤ºï¼š1åº¦ (1Â°) = 60åˆ† (60')ï¼Œ1åˆ† (1') = 60ç§’ (60")
                        </div>

                        <div class="text-sm text-white mb-1 font-bold">1. æ­£é¡è§’ (L) = å‰è¦– - å¾Œè¦–</div>
                        <div class="font-mono text-sm bg-slate-900 p-3 rounded text-slate-300 w-full flex flex-col items-end mb-4">
                            <div>${toDMS(val_L_FS)} (å‰)</div>
                            <div class="border-b border-slate-500 mb-1 w-full text-right">- ${toDMS(val_L_BS)} (å¾Œ)</div>
                            <div class="text-green-400 w-full text-right">= ${toDMS(angL)} (æ­£)</div>
                        </div>

                        <div class="text-sm text-white mb-1 font-bold">2. å€’é¡è§’ (R) = å‰è¦– - å¾Œè¦–</div>
                        <div class="font-mono text-sm bg-slate-900 p-3 rounded text-slate-300 w-full flex flex-col items-end mb-4">
                            <div>${toDMS(val_R_FS)} (å‰)</div>
                            <div class="border-b border-slate-500 mb-1 w-full text-right">- ${toDMS(val_R_BS)} (å¾Œ)</div>
                            <div class="text-green-400 w-full text-right">= ${toDMS(angR)} (å€’)</div>
                        </div>

                        <div class="text-sm text-white mb-1 font-bold">3. å¹³å‡å€¼ = (æ­£ + å€’) Ã· 2</div>
                        <div class="font-mono text-sm bg-slate-900 p-3 rounded text-slate-300 w-full flex flex-col items-end">
                            <div>${toDMS(angL)} (æ­£)</div>
                            <div class="border-b border-slate-500 mb-1 w-full text-right">+ ${toDMS(angR)} (å€’)</div>
                            <div class="mb-2 w-full text-right">${toDMS(angL + angR)} (ç¸½å’Œ)</div>
                            <div class="text-green-400 w-full text-right">Ã· 2 = ${toDMS(final)} (å¹³å‡)</div>
                        </div>
                    </div>
                </div>`;
            
            setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
        }
    </script>
</body>
</html>
